# TikTok Video Recreation App - Database Design Overview

## Data Flow & User Journey
```
User submits TikTok URL → Backend processes video → Scene extraction → Scene recreation → Video generation → Download clips
```

## Core Tables & Relationships

### Table Overview
```
PROJECTS (1) ──────── (M) SCENES
                           │
                           ├── (M) SCENE_IMAGES
                           │
                           └── (M) RECREATED_SCENE_IMAGES (1) ──── (M) SCENE_CLIPS
```

## Detailed Entity Relationships

### 1. PROJECTS
**Purpose**: Main container for each TikTok processing session
- **Relationship**: One-to-many with SCENES
- **Key Responsibilities**: 
  - Store TikTok URL and processed video location
  - Track overall progress/stage
  - Project metadata

### 2. SCENES  
**Purpose**: Represents individual scenes (extracted OR user-created)
- **Relationship**: 
  - Many-to-one with PROJECTS (belongs to one project)
  - One-to-many with SCENE_IMAGES (original candidates)
  - One-to-many with RECREATED_SCENE_IMAGES (AI recreations)
- **Key Responsibilities**:
  - Track scene order and selection status
  - Handle both extracted scenes and user-created scenes
  - Scene metadata

### 3. SCENE_IMAGES
**Purpose**: Original images extracted from source video (candidates per scene)
- **Relationship**: Many-to-one with SCENES
- **Key Responsibilities**:
  - Store original scene image data
  - Handle multiple candidates per scene
  - Reference for recreation process

### 4. RECREATED_SCENE_IMAGES
**Purpose**: AI-generated recreations of scenes (multiple attempts/versions)
- **Relationship**: 
  - Many-to-one with SCENES (which scene this recreates)
  - Optional reference to SCENE_IMAGES (source image, null for user-created)
  - One-to-many with SCENE_CLIPS (videos generated from this image)
- **Key Responsibilities**:
  - Store AI-generated image data
  - Track generation attempts and prompts used
  - Handle both source-based and prompt-only generation

### 5. SCENE_CLIPS
**Purpose**: Final video clips generated from recreated scene images
- **Relationship**: Many-to-one with SCENES table
- **Key Responsibilities**:
  - Store generated video data
  - Track generation prompts and attempts
  - Final output for user download

## Key Design Considerations

### Flexibility Requirements
- **User-created scenes**: SCENES table must handle scenes without source video or without source image
- **Special image format**: Need to accommodate your custom image storage format

### Data Hierarchy
```
Project
├── Scene 1 (extracted)
│   ├── Scene Image 1a (candidate)
│   ├── Scene Image 1b (candidate) 
│   ├── Recreated Image 1 (attempt 1)
│   └── Recreated Image 2 (attempt 2)
│   └── Generated Clip 1 (attempt 2)
├── Scene 2 (extracted + selected)
│   └── ...
└── Scene 3 (user-created)
    ├── Recreated Image 1 (prompt-only)
    └── ...
```

### Stage Tracking
Projects need to track current stage:
- `submitted` → `scene_extraction` → `scene_recreation` → `video_generation` → `completed`

## Table Schema Definitions

### 1. PROJECTS Table ✅

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | PRIMARY KEY | Generated by backend |
| `tiktok_url` | TEXT | NOT NULL | Original TikTok URL submitted by user |
| `name` | TEXT | NULLABLE | User-defined project name (optional) |
| `story_description` | TEXT | NULLABLE | Background/context to help AI understand scenes (user input) |
| `story_global_changes` | TEXT | NULLABLE | Global information for scene processing agents (user input) |
| `settings` | JSON | NULLABLE | UI settings and configuration data |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | When project was created |
| `modified_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | Last modification time |

**Notes:**
- Projects are only created after video processing and scene splitting is complete
- No status tracking needed (exists in DB = ready state)
- GCS video URL can be deduced from project ID (not stored)
- `story_description` and `story_global_changes` are mutable user inputs
- `settings` stores flexible UI configuration as JSON object
- Core project structure is immutable, but context fields can be updated

### 2. SCENES Table ✅

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Auto-generated scene ID |
| `project_id` | UUID | NOT NULL, FK to projects.id | Parent project reference |
| `scene_order` | INTEGER | NOT NULL | Gap-based ordering (100, 200, 300...) for easy insertions |
| `is_selected` | BOOLEAN | DEFAULT FALSE | Whether user selected scene for processing |
| `selected_image_id` | INTEGER | NULLABLE, FK to scene_images.id | Selected original scene image |
| `selected_generated_image_id` | INTEGER | NULLABLE, FK to scene_generated_scene_images.id | Selected AI-generated image |
| `selected_clip_id` | INTEGER | NULLABLE, FK to scene_clips.id | Selected video clip |
| `settings` | JSON | NULLABLE | Scene-specific configuration and UI settings |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | When scene was created |

**Notes:**
- Supports both extracted scenes and user-created scenes
- `scene_order` uses gap-based integers (100, 200, 300) to allow mid-list insertions without mass updates
- Three selection fields track user's chosen assets at each stage of the workflow
- All selections are nullable to support different workflow stages

### 3. SCENE_IMAGES Table ✅

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Auto-generated image ID |
| `scene_id` | INTEGER | NOT NULL, FK to scenes.id | Parent scene reference |
| `gcs_url` | TEXT | NOT NULL | URL to image stored in Google Cloud Storage |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | When image was processed/stored |

**Notes:**
- Images are ordered by `created_at` (temporal order from video processing)
- No explicit ordering field needed since insertion order = processing order
- Selection state is managed in the SCENES table via `source_img_id`

### 4. GENERATED_SCENE_IMAGES Table ✅

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Auto-generated image ID |
| `scene_id` | INTEGER | NOT NULL, FK to scenes.id | Parent scene reference |
| `gcs_url` | TEXT | NOT NULL | URL to generated image in Google Cloud Storage |
| `generation_sources` | JSON | NULLABLE | Sources used for generation (prompt, images, mask) |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | When image was generated |

**Notes:**
- Each generated image is independent (no versioning/attempt tracking)
- Selection state managed in SCENES table via `generated_img_id`
- `generation_sources` JSON structure example:
  ```json
  {
    "prompt": "optional text prompt",
    "images": ["gcs_url1", "gcs_url2"],
    "mask": "gcs_url_to_mask"
  }
  ```
- Works for both "recreated from source" and "created from scratch" scenarios

### 5. SCENE_CLIPS Table ✅

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | Auto-generated clip ID |
| `scene_id` | INTEGER | NOT NULL, FK to scenes.id | Parent scene reference |
| `gcs_url` | TEXT | NOT NULL | URL to generated video clip in Google Cloud Storage |
| `generation_sources` | JSON | NULLABLE | Sources used for video generation (prompt, images, etc.) |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | When video was generated |

**Notes:**
- Each video clip is independent (no versioning/attempt tracking)
- Selection state managed in SCENES table via `selected_clip_id`
- `generation_sources` stores flexible input data as URLs (no rigid FK relationships)
- Typically includes generated image URL and text prompt for video generation

---

## Next Steps
1. ✅ PROJECTS table defined
2. ✅ SCENES table defined  
3. ✅ SCENE_IMAGES table defined
4. ✅ RECREATED_SCENE_IMAGES table defined
5. ⏳ Define SCENE_CLIPS table schema
6. ⏳ Add indexes and optimization considerations